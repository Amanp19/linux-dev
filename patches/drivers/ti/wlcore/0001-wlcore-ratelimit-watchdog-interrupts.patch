From d43ad6ffdd4e161a7095b9ba04579c60dbbcaf42 Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Fri, 4 Nov 2016 10:48:04 -0500
Subject: [PATCH] wlcore: ratelimit watchdog interrupts

Signed-off-by: Robert Nelson <robertcnelson@gmail.com>
---
 drivers/net/wireless/ti/wlcore/debug.h | 3 +++
 drivers/net/wireless/ti/wlcore/main.c  | 4 ++--
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/drivers/net/wireless/ti/wlcore/debug.h b/drivers/net/wireless/ti/wlcore/debug.h
index 27bfb7c..8805690 100644
--- a/drivers/net/wireless/ti/wlcore/debug.h
+++ b/drivers/net/wireless/ti/wlcore/debug.h
@@ -64,6 +64,9 @@ extern u32 wl12xx_debug_level;
 #define wl1271_error(fmt, arg...) \
 	pr_err(DRIVER_PREFIX "ERROR " fmt "\n", ##arg)
 
+#define wl1271_error_ratelimited(fmt, arg...) \
+	pr_err_ratelimited(DRIVER_PREFIX "ERROR " fmt "\n", ##arg)
+
 #define wl1271_warning(fmt, arg...) \
 	pr_warn(DRIVER_PREFIX "WARNING " fmt "\n", ##arg)
 
diff --git a/drivers/net/wireless/ti/wlcore/main.c b/drivers/net/wireless/ti/wlcore/main.c
index ef6c15b..bfde942 100644
--- a/drivers/net/wireless/ti/wlcore/main.c
+++ b/drivers/net/wireless/ti/wlcore/main.c
@@ -567,7 +567,7 @@ static int wlcore_irq_locked(struct wl1271 *wl)
 		}
 
 		if (unlikely(intr & WL1271_ACX_INTR_WATCHDOG)) {
-			wl1271_error("HW watchdog interrupt received! starting recovery.");
+			wl1271_error_ratelimited("HW watchdog interrupt received! starting recovery.");
 			wl->watchdog_recovery = true;
 			ret = -EIO;
 
@@ -576,7 +576,7 @@ static int wlcore_irq_locked(struct wl1271 *wl)
 		}
 
 		if (unlikely(intr & WL1271_ACX_SW_INTR_WATCHDOG)) {
-			wl1271_error("SW watchdog interrupt received! "
+			wl1271_error_ratelimited("SW watchdog interrupt received! "
 				     "starting recovery.");
 			wl->watchdog_recovery = true;
 			ret = -EIO;
-- 
2.10.1

